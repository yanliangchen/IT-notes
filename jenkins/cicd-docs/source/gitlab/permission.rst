权限管理
++++++++++

使用 ``root`` 用户进入 Gitlab 服务首页，如下所示

.. image:: /images/gitlab/gitlab首页.png

点击导航栏中的 ``admin area`` 小扳手进入管理界面

.. image:: /images/gitlab/管理界面.png

创建用户
""""""""""

1. 点击 ``New User`` 按钮，创建新的用户。

    .. image:: /images/gitlab/新建组按钮.png

2. 进入新建用户配置页面

    .. image:: /images/gitlab/新建用户配置页面.png

3. 配置选项

    +----------+-----------------------+--------------------------------------------------------------------------------------------+
    |   内容   |          选项         |                                         含义与作用                                         |
    +==========+=======================+============================================================================================+
    |          |          Name         |                                          账户名称                                          |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    | Account  |        Username       |                                           用户名                                           |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    |          |         Email         |                                          邮箱地址                                          |
    +----------+-----------------------+--------------------------------------------------------------------------------------------+
    | Password |        Password       |                                            密码                                            |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    |          | Password confirmation |                                          确认密码                                          |
    +----------+-----------------------+--------------------------------------------------------------------------------------------+
    |          |     Projects limit    |                                          项目限制                                          |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    |          |    Can create group   |                                        是否能创建组                                        |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    |  Access  |      Access level     |                                     Regular (普通用户)                                     |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    |          |      Access level     |                                      Admin（管理员）                                       |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    |          |        External       | 除非明确授予访问权限，否则外部用户无法查看内部或私有项目。此外，外部用户无法创建项目或组。 |
    +----------+-----------------------+--------------------------------------------------------------------------------------------+
    |          |         Acatar        |                                            头像                                            |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    |          |         Skype         |                                                                                            |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    | Profile  |        Linkedin       |                                                                                            |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    |          |        Twitter        |                                                                                            |
    +          +-----------------------+--------------------------------------------------------------------------------------------+
    |          |        Website        |                                                                                            |
    +----------+-----------------------+--------------------------------------------------------------------------------------------+


创建组
""""""""

为什么需要有组？比如公司现在有开发团队，有不同项目，可以按照不同项目来分配组，组内包含了不同的成员。

1. 点击 ``New Group`` 按钮，创建新的用户组。

    .. image:: /images/gitlab/新建组按钮.png
    
2. 进入新建组配置页面

    .. image:: /images/gitlab/组配置信息.png

3. 配置选项

    +---------------------------+-------------------------------------------------------------------------------+
    |            选项           |                                   含义与作用                                  |
    +===========================+===============================================================================+
    |         Group path        |                                组项目 URL 路径                                |
    +---------------------------+-------------------------------------------------------------------------------+
    |         Group name        |                                   组项目名称                                  |
    +---------------------------+-------------------------------------------------------------------------------+
    |        Description        |                                   组项目描述                                  |
    +---------------------------+-------------------------------------------------------------------------------+
    |        Group avatar       |                                   组项目图标                                  |
    +---------------------------+-------------------------------------------------------------------------------+
    |                           |                     Private（该组及其项目只能由成员查看）                     |
    +                           +-------------------------------------------------------------------------------+
    |                           |              Internal（任何登录用户都可以查看该组和任何内部项目）             |
    +                           +-------------------------------------------------------------------------------+
    |      Visibility Level     |              Public（无需任何身份验证即可查看该组和任何公共项目）             |
    +                           +-------------------------------------------------------------------------------+
    |                           | Allow users to request access（如果公开或内部可见性，则允许用户请求访问权限） |
    +---------------------------+-------------------------------------------------------------------------------+
    |     Large File Storage    |                          允许该组中的项目使用Git LFS                          |
    +---------------------------+-------------------------------------------------------------------------------+
    | Two-factor authentication |                    要求此组中的所有用户都设置双因素身份验证                   |
    +---------------------------+-------------------------------------------------------------------------------+

4. 组创建成功

    .. image:: /images/gitlab/组详细页面.png

5. 组授权

    组创建完成后，组内是没有用户的，创建组的用户就要赋权给其他的用户

    * 选择用户加入组

        .. image:: /images/gitlab/选择用户加入组.png

    * 设置用户在组中的角色

        .. image:: /images/gitlab/设置用户角色.png

    * 查看组成员

        .. image:: /images/gitlab/查看组成员.png

创建项目
""""""""""

1. 点击 ``New project`` 按钮，创建新的项目。

    .. image:: /images/gitlab/新建项目按钮.png

2. 进入新建项目配置页面

    .. image:: /images/gitlab/新建项目.png

3. 选项配置

    +---------------------------------------+----------------------------+
    |                  选项                 |         含义与作用         |
    +=======================================+============================+
    |              Project name             |          项目名称          |
    +---------------------------------------+----------------------------+
    |              Project URL              |          项目URL           |
    +---------------------------------------+----------------------------+
    |              Project slug             |           项目块           |
    +---------------------------------------+----------------------------+
    |          Project description          |          项目描述          |
    +---------------------------------------+----------------------------+
    |                                       |      Private（私有）       |
    +                                       +----------------------------+
    |            Visibility Level           |      Internal（内部）      |
    +                                       +----------------------------+
    |                                       |       Public（公有）       |
    +---------------------------------------+----------------------------+
    | Initialize repository with a README、 | 初始化存储库的 README 文件 |
    +---------------------------------------+----------------------------+

项目密钥
""""""""""""

1. 给用户添加密钥

    当我们创建完成了组、用户与项目之后，用户需要上传公钥，否则 SSH 协议不能使用。

    * 点击页面右上方的用户头像

        .. image:: /images/gitlab/用户设置.png

    * 进入用户配置页面，查看左侧用户配置选项

        .. image:: /images/gitlab/用户配置选项.png

    * 点击 ``SSH keys`` ，为用户添加 SSH 公钥

        .. image:: /images/gitlab/SSH公钥配置.png

2. 本地生成密钥对

    * 用户本地主机生成密钥对

        .. code-block:: none

            $ ssh-keygen -b 4096 -t rsa -f ~/.ssh/gitlab -N ''
            Generating public/private rsa key pair.
            Your identification has been saved in /Users/renkeju/.ssh/gitlab.
            Your public key has been saved in /Users/renkeju/.ssh/gitlab.pub.
            The key fingerprint is:
            SHA256:s427VY2KNaGXemMwu3ird02IK4/lo7OHCA7vLHfcAmI renkeju@laptop.local
            The key's randomart image is:
            +---[RSA 4096]----+
            |                 |
            |                 |
            |          .      |
            |         . o o   |
            |        S.=.o .  |
            |oEo     .&.+.    |
            |.= + o .B.Bo     |
            |..+ = ==**...    |
            | +o. .*@B=       |
            +----[SHA256]-----+

    * 查看密钥对

        .. code-block:: none

            $ ll .ssh/gitlab*
            -rw-------  1 renkeju  staff   3.2K  9 27 15:46 .ssh/gitlab
            -rw-r--r--  1 renkeju  staff   746B  9 27 15:46 .ssh/gitlab.pub

    * 复制公钥

        .. code-block:: none

            $ cat .ssh/gitlab.pub
            ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDIAmL6Hgb1hyi8ErvF2kd0o4lYVwn8EecdyMBrSViOjj0FxFz5NBXVZgZziuKiYN9EBQt+cf+ehbUquLJY/w5S3Rg08x8QMKnJCtQ0vK8vmuO6ljUxHlBzyQiSs4dQWIwhAUL5hJ+BrAHp+PbPvuX7nwZILPCGLZTlMIBTWIQtUwdZQDQmWZ0xxsXlHoa0w4NNgUcJOgrFF2A0E4jrzAOdUKWQfhCSBXEd6BZJ+QGOcRmIL3fPasJL3+B8X5GNs56DpXeByXLGSwgU605bog9oU6N3WqHvoLa1LwwUmpfospEB1DimS/7a31nMPera026Hvr851QUUAxZGjpYxZodJ1QcscH4ZOgafFZnH+8UiU6LWreb4cj/o56i+TuKntOAlQNb6R0M9C4E3B5BQI8l6Ob5nkr7ltujDTJGtTFPlF0oBxEqgkpnvjkLicZ6biCDa3f2bEU7k5Ez/kyrA1w639gnfF58KzyZuuhM9HG1ANK4KO9LGr/5MMqjbkr8ksiqcNG17YSmdQVWqmLU5Ai2tEnA5KLjHwiv2MXrzpBe1elIUXW7AHps+Tx+e/Q56K3vfJ43adxh+E+cFDqPyjpsBWdc6m7Js7hXuQ2Z5iFSVfyh9YxwmJudHLTkhTZhJi18qjnPyNy9Q/WwKVRq0NWXfqcd3aWjvmNXLe7HAXfhi7Q== renkeju@laptop.local

3. 配置公钥

    * 将公钥黏贴到文本框内 

        .. image:: /images/gitlab/将公钥黏贴到文本框内.png

    * 已添加的公钥列表

        .. image:: /images/gitlab/已添加公钥列表.png

部署密钥
"""""""""""

每个 Repository 部署密钥
''''''''''''''''''''''''''

deploy keys 允许使用单个 SSH 密钥对 对一个或多个项目进行只读或读写（如果已启用）访问。

这对于将Repository克隆岛 Continuous Integration (CI) 服务器非常有用。通过使用部署密钥，您不必设置虚拟用户账户。如果您是项目维护者或所有者，则可以在”Repository“部分下的项目设置中添加部署密钥。为新部署密钥指定标题并黏贴 SSH 公钥。在这之后，使用相应的 SSH 私钥的计算机具有对项目有只读和读写（如果启用）访问权限。

.. image:: /images/gitlab/项目部署密钥.png

您无法使用表单两次添加相同的部署密钥。如果要将相同的密钥添加到另一个项目，请在”从可用项目部署密钥“列表中启用它。您可以访问的所有项目的所有部署密钥都可用。该项目访问可以通过称为项目的直接成员或通过组来实现。

部署密钥可以在项目之间共享，您只需要将它们添加到每个项目中。

全局共享部署密钥
''''''''''''''''''

Global Shared Deploy keys 允许在整个 Gitlab 安装中的任何Repository上配置只读或读写（如果启用）访问。

这对于将Repository集成到安全的共享持续集成（CI）服务或其他共享服务非常有用。Gitlab 管理员可以在 Gitlab 中设置 Global Shared Deploy keys，并将私钥添加到任何共享系统。当项目维护者（或更高级别）授权将 Global Shared Deploy keys 用于其项目时，各个Repository会选择使用这些密钥公开其Repository。

与每个项目部署密钥相比，全局共享密钥可以提供更高的安全性，因为目标集成系统的管理员是唯一需要知道和配置私钥的人。

Gitlab 管理员在”部署密钥“部分下的”管理“区域中设置 Global Depoly keys 。确保密钥具有有意义的标题，因为这将是项目维护者和所有者识别要添加的正确 Global Deploy keys 的主要方式。例如，如果密钥提供对 SaaS CI 实例的访问权限，则在密钥名称中使用该服务的名称（如果它是用于全局）。在创建全局共享部署密钥时，请考虑密钥的粒度 —— 它们的使用范围非常狭窄，例如知识特定服务或更广泛的用途，例如“您需要提供对Repository的读取访问权限”。

一旦 Gitlab 管理员添加全局部署密钥，项目维护人员和所有者就可以通过展开 “部署密钥” 部分并单击任何项目可用的公共部署密钥下列出的相应密钥旁边的“启用”，将其添加到项目的 "Settings" -> "Repository" 部分中。

1. 导航栏选择小扳手

    使用具有管理员权限的用户登录才可以看到小扳手

    .. image:: /images/gitlab/导航栏.png

2. 左侧导航栏选择 ``Deploy keys`` 选项

    .. image:: /images/gitlab/左侧选择栏.png

3. 点击 ``New deploy key`` 按钮

    .. image:: /images/gitlab/新建公共部署密钥.png

4. 黏贴公钥到框内，点击 ``Create`` 按钮创建

    .. image:: /images/gitlab/公共部署密钥.png

5. 切换到其他用户，添加公共权限部署密钥

    .. image:: /images/gitlab/添加公共权限部署密钥.png

6. 启用公共部署密钥

    .. image:: /images/gitlab/启用公共部署密钥.png

7. 查看已启用部署密钥

    .. image:: /images/gitlab/已启用部署密钥.png

.. note:: 

    只有配置了至少一个 Global Deploy keys 时，才会显示 可用于任何项目 的标题公共部署密钥。

.. attention:: 

    定义全局部署密钥不会通过密钥公开任何给定的 Repository ，知道该 Repository 将 Global Deploy keys 添加到其项目中。通过这种方式，全局部署密钥可以启用其他系统的访问，但不要仅通过它们来隐式地提供任何访问。

