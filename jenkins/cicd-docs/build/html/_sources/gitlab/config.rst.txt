配置
+++++++++

安装完成后需要进行的配置，配置文件如下表所示：

+-------------------------------------------------+---------------------------------------------------------------------------+
|                       路径                      |                                    内容                                   |
+-------------------------------------------------+---------------------------------------------------------------------------+
| ``/var/opt/gitlab/git-data/repostitories/root`` |                               库默认存储目录                              |
+-------------------------------------------------+---------------------------------------------------------------------------+
|                 ``/opt/gitlab``                 |                          应用代码和相应的依赖程序                         |
+-------------------------------------------------+---------------------------------------------------------------------------+
|               ``/var/opt/gitlab``               | ``gitlab reconfigure`` 命令编译后的应用数据和配置文件，不需要人为修改配置 |
+-------------------------------------------------+---------------------------------------------------------------------------+
|                 ``/etc/gitlab``                 |                                配置文件目录                               |
+-------------------------------------------------+---------------------------------------------------------------------------+
|               ``/var/log/gitlab``               |                  此目录下存放了 gitlab 各个组件产生的日志                 |
+-------------------------------------------------+---------------------------------------------------------------------------+
|           ``/var/opt/gitlab/backups/``          |                             备份文件生成的目录                            |
+-------------------------------------------------+---------------------------------------------------------------------------+

修改配置文件
""""""""""""""""

因为 gitlab 是使用 ruby 编写的，所以它的配置文件后缀名是 rb。

.. code-block:: bash

    vim /etc/gitlab/gitlab.rb
    external_url 'your_ip_address_or_domain_name'

修改完成之后，需要重新加载配置文件，执行如下命令：

.. code-block:: bash

    sudo gitlab-ctl reconfigure

执行完成后，通过浏览器访问IP地址或域名，因为首次访问，Gitlab 需要你为 ``root`` 设置一个新的密码。

.. image:: /images/gitlab/设置密码.png

注册完成之后，就会跳转到访问页面，此时你可以使用 ``root`` 用户访问，但是建议额外注册一个管理员用户来管理 Gitlab 服务。

.. image:: /images/gitlab/注册新用户.png

变更主配置文件
""""""""""""""""

每当我们要变更配置文件，需要执行以下步骤

1. ``gitlab-ctl reconfigure`` 重置配置文件
2. ``gitlab-ctl show-config`` 验证配置文件
3. ``gitlab-ctl restart``  重启配置文件

修改 root 用户密码
""""""""""""""""""""""

对于普通用户而言，通过系统的重置密码，接收重置密码邮件即可，可是 Gitlab 的管理员账号，缺省的邮箱是一个不存在的邮箱地址，所在没有办法通过邮箱来重置密码。

使用命令 ``gitlab-rails console production`` 修改

.. code-block:: none

    gitlab-rails console production
    -------------------------------------------------------------------------------------
    GitLab:       11.3.0 (17bd59a)
    GitLab Shell: 8.3.3
    postgresql:   9.6.8
    -------------------------------------------------------------------------------------
    Loading production environment (Rails 4.2.10)
    irb(main):001:0>
    irb(main):002:0* user = User.where(id: 1).first
    => #<User id:1 @root>
    irb(main):003:0> user.password=12345678
    => 12345678
    irb(main):004:0> user.password_confirmation=12345678
    => 12345678
    irb(main):005:0> user.save!
    Enqueued ActionMailer::DeliveryJob (Job ID: de0469c0-dea5-488d-9e04-8d4c550739c5) to Sidekiq(mailers) with arguments: "DeviseMailer", "password_change", "deliver_now", gid://gitlab/User/1
    => true
    irb(main):006:0> quit

