

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gitlab &mdash; cicd alpha documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="jenkins" href="../jenkins/jenkins.html" />
    <link rel="prev" title="git" href="../git/git.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> cicd
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../git/git.html">git</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">gitlab</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">安装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rhel-centos">RHEL/CentOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ubuntu">Ubuntu</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id2">命令</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">状态查询</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">查看日志</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">启动服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">关闭服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">重启服务</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id8">配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">修改配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">变更主配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#root">修改 root 用户密码</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id11">权限管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id12">创建用户</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">创建组</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">创建项目</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id15">项目密钥</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">部署密钥</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#repository">每个 Repository 部署密钥</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">全局共享部署密钥</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#issues">issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id18">使用 issues 来管理需求与缺陷</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#issue">录入 issue</a></li>
<li class="toctree-l4"><a class="reference internal" href="#review-issue">Review issue 并为其打上标签</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">Issue 的后续操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">使用 issue 做项目里程碑管理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#issue-board">使用 issue board</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#merge-request">基于 Merge Request 的开发流程</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#merge-request-code-review">创建 Merge Request 并进行 Code Review</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mr">灵活创建新分支来避免 MR 冲突</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">分拆大的 Merge Request</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id23">备份管理</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id24">配置文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id25">备份时间戳</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id26">备份策略选项</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id27">排除特定目录</a></li>
<li class="toctree-l3"><a class="reference internal" href="#crontab">使用 crontab 定时备份</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id28">恢复备份</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id29">邮件配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id30">修改配置文件</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../jenkins/jenkins.html">jenkins</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">cicd</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>gitlab</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/gitlab/gitlab.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="gitlab">
<h1>gitlab<a class="headerlink" href="#gitlab" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>一个基于 GIT 的源码托管解决方案</li>
<li>基于 Ruby on rails 开发</li>
<li>集成了 nginx postgreSQL redis sidekiq 等组件</li>
</ul>
<div class="section" id="id1">
<h2>安装<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="72%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>组件</td>
<td>作用</td>
</tr>
<tr class="row-even"><td>nginx</td>
<td>静态 Web 服务器</td>
</tr>
<tr class="row-odd"><td>gitlab-shell</td>
<td>用于处理 Git 命令和修改 authorized keys 列表</td>
</tr>
<tr class="row-even"><td>gitlab-workhorse</td>
<td>轻量级的反向代理服务器</td>
</tr>
<tr class="row-odd"><td>logrotate</td>
<td>日志文件管理工具</td>
</tr>
<tr class="row-even"><td>postgresql</td>
<td>数据库</td>
</tr>
<tr class="row-odd"><td>redis</td>
<td>缓存数据库</td>
</tr>
<tr class="row-even"><td>sidekiq</td>
<td>用于在后台执行队列任务（异步执行）</td>
</tr>
<tr class="row-odd"><td>unicorn</td>
<td>Gitlab Rails 应用是托管在这个服务器上面的</td>
</tr>
</tbody>
</table>
<div class="section" id="rhel-centos">
<h3>RHEL/CentOS<a class="headerlink" href="#rhel-centos" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">安装并配置必要的依赖项</p>
<blockquote>
<div><p>在 CentOS7/RHEL&nbsp;系统中，下面的命令将会在系统防火墙中开放 HTTP/HTTPS 和 SSH 端口</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo yum install -y curl policycoreutils-python openssh-server
sudo systemctl <span class="nb">enable</span> sshd
sudo systemctl start sshd
sudo firewall-cmd --permanent --add-service<span class="o">=</span>http
sudo firewall-cmd --permanent --add-service<span class="o">=</span>https
sudo systemctl reload firewalld
</pre></div>
</div>
<p>接下来，安装Postfix以发送通知电子邮件。如果要使用其他解决方案发送电子邮件，请跳过此步骤并在安装GitLab后配置外部SMTP服务器。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo yum install postfix
sudo systemctl <span class="nb">enable</span> postfix
sudo systemctl start postfix
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">添加 GitLab 软件包存储库并安装软件包</p>
<blockquote>
<div><p>新建 <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d/gitlab-ce.repo</span></code> , 内容为：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; <span class="s2">&quot;EOF&quot;</span> &gt; /etc/yum.repos.d/gitlab-ce.repo
<span class="o">[</span>gitlab-ce<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>Gitlab CE Repository
<span class="nv">baseurl</span><span class="o">=</span>https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el<span class="nv">$releasever</span>/
<span class="nv">gpgcheck</span><span class="o">=</span><span class="m">0</span>
<span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
EOF
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo yum makecache
sudo yum install -y gitlab-ce
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">浏览主机并登陆</p>
<blockquote>
<div><p>首次访问时，您将被重定向到密码重置屏幕。提供初始管理员帐户的密码，您将被重定向回登录屏幕。使用默认帐户的用户名 <code class="docutils literal notranslate"><span class="pre">root</span></code> 登录。</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="ubuntu">
<h3>Ubuntu<a class="headerlink" href="#ubuntu" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">安装并配置必要的依赖项</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get update
sudo apt-get install -y curl openssh-server ca-certificates
</pre></div>
</div>
<p>接下来，安装Postfix以发送通知电子邮件。如果要使用其他解决方案发送电子邮件，请跳过此步骤并在安装GitLab后配置外部SMTP服务器。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install -y postfix
</pre></div>
</div>
<p>在Postfix安装期间，可能会出现配置屏幕。选择 “Internet Site” 并按Enter键。使用服务器的外部DNS作为“邮件名称”，然后按Enter键。如果出现其他屏幕，请继续按Enter键接受默认值。</p>
</div></blockquote>
</li>
<li><p class="first">添加GitLab软件包存储库并安装软件包</p>
<blockquote>
<div><p>首先信任 GitLab 的 GPG 公钥:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl https://packages.gitlab.com/gpg.key <span class="m">2</span>&gt; /dev/null <span class="p">|</span> sudo apt-key add - <span class="p">&amp;</span>&gt;/dev/null
</pre></div>
</div>
<p>再选择你的 Debian/Ubuntu 版本，文本框中内容写进 <code class="docutils literal notranslate"><span class="pre">/etc/apt/sources.list.d/gitlab-ce.list</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo cat <span class="s">&lt;&lt; EOF &gt; /etc/apt/sources.list.d/gitlab-ce.list</span>
<span class="s">deb https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/ubuntu xenial main</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>安装 gitlab-ce ：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get update
sudo apt-get install gitlab-ce
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">浏览主机并登陆</p>
<blockquote>
<div><p>首次访问时，您将被重定向到密码重置屏幕。提供初始管理员帐户的密码，您将被重定向回登录屏幕。使用默认帐户的用户名 <code class="docutils literal notranslate"><span class="pre">root</span></code> 登录。</p>
</div></blockquote>
</li>
</ol>
</div>
</div>
<div class="section" id="id2">
<h2>命令<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>状态查询<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>通过命令可以查看各服务组件的运行状态</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gitlab-ctl status
run: alertmanager: <span class="o">(</span>pid <span class="m">12966</span><span class="o">)</span> 4279s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12980</span><span class="o">)</span> 4279s
run: gitaly: <span class="o">(</span>pid <span class="m">12895</span><span class="o">)</span> 4281s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12978</span><span class="o">)</span> 4279s
run: gitlab-monitor: <span class="o">(</span>pid <span class="m">12928</span><span class="o">)</span> 4280s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12936</span><span class="o">)</span> 4280s
run: gitlab-workhorse: <span class="o">(</span>pid <span class="m">12877</span><span class="o">)</span> 4281s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12950</span><span class="o">)</span> 4280s
run: logrotate: <span class="o">(</span>pid <span class="m">20523</span><span class="o">)</span> 726s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12952</span><span class="o">)</span> 4280s
run: nginx: <span class="o">(</span>pid <span class="m">12398</span><span class="o">)</span> 4332s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12951</span><span class="o">)</span> 4280s
run: node-exporter: <span class="o">(</span>pid <span class="m">12620</span><span class="o">)</span> 4314s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12924</span><span class="o">)</span> 4280s
run: postgres-exporter: <span class="o">(</span>pid <span class="m">12987</span><span class="o">)</span> 4279s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">13069</span><span class="o">)</span> 4278s
run: postgresql: <span class="o">(</span>pid <span class="m">12125</span><span class="o">)</span> 4372s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12864</span><span class="o">)</span> 4281s
run: prometheus: <span class="o">(</span>pid <span class="m">12943</span><span class="o">)</span> 4280s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12961</span><span class="o">)</span> 4279s
run: redis: <span class="o">(</span>pid <span class="m">12050</span><span class="o">)</span> 4378s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12863</span><span class="o">)</span> 4281s
run: redis-exporter: <span class="o">(</span>pid <span class="m">12705</span><span class="o">)</span> 4302s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">13068</span><span class="o">)</span> 4279s
run: sidekiq: <span class="o">(</span>pid <span class="m">12371</span><span class="o">)</span> 4334s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12931</span><span class="o">)</span> 4280s
run: unicorn: <span class="o">(</span>pid <span class="m">12328</span><span class="o">)</span> 4340s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12930</span><span class="o">)</span> 4280s
</pre></div>
</div>
<p>也可以指定查看某个服务</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gitlab-ctl status nginx
run: nginx: <span class="o">(</span>pid <span class="m">12398</span><span class="o">)</span> 4463s<span class="p">;</span> run: log: <span class="o">(</span>pid <span class="m">12951</span><span class="o">)</span> 4411s
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>查看日志<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>如果想查看某个服务的日志，可以使用如下命令</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gitlab-ctl tail <span class="nv">nginx</span>
<span class="o">==</span>&gt; /var/log/gitlab/nginx/current &lt;<span class="o">==</span>

<span class="o">==</span>&gt; /var/log/gitlab/nginx/error.log &lt;<span class="o">==</span>

<span class="o">==</span>&gt; /var/log/gitlab/nginx/gitlab_access.log &lt;<span class="o">==</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:11:59:37 +0800<span class="o">]</span> <span class="s2">&quot;POST /profile/preferences HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">585</span> <span class="s2">&quot;http://192.168.47.132/profile/preferences&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:11:59:42 +0800<span class="o">]</span> <span class="s2">&quot;POST /profile/preferences HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">585</span> <span class="s2">&quot;http://192.168.47.132/profile/preferences&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:11:59:43 +0800<span class="o">]</span> <span class="s2">&quot;GET /profile/keys HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">7587</span> <span class="s2">&quot;http://192.168.47.132/profile/preferences&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:11:59:43 +0800<span class="o">]</span> <span class="s2">&quot;GET /assets/webpack/pages.profiles.keys.963cb5f3.chunk.js HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">803</span> <span class="s2">&quot;http://192.168.47.132/profile/keys&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:11:59:45 +0800<span class="o">]</span> <span class="s2">&quot;GET /profile/chat_names HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">6725</span> <span class="s2">&quot;http://192.168.47.132/profile/keys&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:11:59:47 +0800<span class="o">]</span> <span class="s2">&quot;GET / HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">7539</span> <span class="s2">&quot;http://192.168.47.132/profile/chat_names&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:12:01:58 +0800<span class="o">]</span> <span class="s2">&quot;GET /projects/new HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">13013</span> <span class="s2">&quot;http://192.168.47.132/&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:12:01:58 +0800<span class="o">]</span> <span class="s2">&quot;GET /assets/webpack/commons~pages.projects~pages.projects.activity~pages.projects.artifacts.browse~pages.projects.artifa~1485fd35.d346ca1a.chunk.js HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">7340</span> <span class="s2">&quot;http://192.168.47.132/projects/new&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:12:01:58 +0800<span class="o">]</span> <span class="s2">&quot;GET /assets/webpack/pages.projects.new.0fa98a30.chunk.js HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">1667</span> <span class="s2">&quot;http://192.168.47.132/projects/new&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>
<span class="m">192</span>.168.47.1 - - <span class="o">[</span><span class="m">27</span>/Sep/2018:12:02:11 +0800<span class="o">]</span> <span class="s2">&quot;GET /import/github/new HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">6206</span> <span class="s2">&quot;http://192.168.47.132/projects/new&quot;</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36&quot;</span>

<span class="o">==</span>&gt; /var/log/gitlab/nginx/gitlab_error.log &lt;<span class="o">==</span>

<span class="o">==</span>&gt; /var/log/gitlab/nginx/access.log &lt;<span class="o">==</span>
</pre></div>
</div>
<p>也可以前往服务组件的日志目录进行查看：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ll /var/log/gitlab/
total <span class="m">0</span>
drwx------ <span class="m">2</span> gitlab-prometheus root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 alertmanager
drwx------ <span class="m">2</span> git               root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 gitaly
drwx------ <span class="m">2</span> git               root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 gitlab-monitor
drwx------ <span class="m">2</span> git               root       <span class="m">216</span> Sep <span class="m">27</span> <span class="m">11</span>:00 gitlab-rails
drwx------ <span class="m">2</span> git               root        <span class="m">30</span> Sep <span class="m">27</span> <span class="m">10</span>:59 gitlab-shell
drwx------ <span class="m">2</span> git               root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 gitlab-workhorse
drwx------ <span class="m">2</span> root              root        <span class="m">47</span> Sep <span class="m">27</span> <span class="m">11</span>:00 logrotate
drwxr-x--- <span class="m">2</span> root              gitlab-www <span class="m">131</span> Sep <span class="m">27</span> <span class="m">11</span>:00 nginx
drwx------ <span class="m">2</span> gitlab-prometheus root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 node-exporter
drwx------ <span class="m">2</span> gitlab-psql       root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 postgres-exporter
drwx------ <span class="m">2</span> gitlab-psql       root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 postgresql
drwx------ <span class="m">2</span> gitlab-prometheus root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 prometheus
drwxr-xr-x <span class="m">2</span> root              root        <span class="m">28</span> Sep <span class="m">27</span> <span class="m">10</span>:59 reconfigure
drwx------ <span class="m">2</span> gitlab-redis      root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 redis
drwx------ <span class="m">2</span> gitlab-redis      root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 redis-exporter
drwx------ <span class="m">2</span> git               root        <span class="m">82</span> Sep <span class="m">27</span> <span class="m">11</span>:01 sidekiq
drwx------ <span class="m">2</span> git               root       <span class="m">134</span> Sep <span class="m">27</span> <span class="m">11</span>:01 unicorn
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>启动服务<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>可以启动指定的服务，也可以启动全部服务</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gitlab-ctl start
gitlab-ctl start nginx
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>关闭服务<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>可以关闭指定的服务，也可以关闭全部服务</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gitlab-ctl stop
gitlab-ctl stop nginx
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>重启服务<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>可以重启指定的服务，也可以重启全部服务</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gitlab-ctl restart
gitlab-ctl restart nginx
</pre></div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>配置<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>安装完成后需要进行的配置，配置文件如下表所示：</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>路径</td>
<td>内容</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">/var/opt/gitlab/git-data/repostitories/root</span></code></td>
<td>库默认存储目录</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">/opt/gitlab</span></code></td>
<td>应用代码和相应的依赖程序</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">/var/opt/gitlab</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">gitlab</span> <span class="pre">reconfigure</span></code> 命令编译后的应用数据和配置文件，不需要人为修改配置</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">/etc/gitlab</span></code></td>
<td>配置文件目录</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">/var/log/gitlab</span></code></td>
<td>此目录下存放了 gitlab 各个组件产生的日志</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">/var/opt/gitlab/backups/</span></code></td>
<td>备份文件生成的目录</td>
</tr>
</tbody>
</table>
<div class="section" id="id9">
<h3>修改配置文件<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>因为 gitlab 是使用 ruby 编写的，所以它的配置文件后缀名是 rb。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim /etc/gitlab/gitlab.rb
external_url <span class="s1">&#39;your_ip_address_or_domain_name&#39;</span>
</pre></div>
</div>
<p>修改完成之后，需要重新加载配置文件，执行如下命令：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo gitlab-ctl reconfigure
</pre></div>
</div>
<p>执行完成后，通过浏览器访问IP地址或域名，因为首次访问，Gitlab 需要你为 <code class="docutils literal notranslate"><span class="pre">root</span></code> 设置一个新的密码。</p>
<img alt="../_images/设置密码.png" src="../_images/设置密码.png" />
<p>注册完成之后，就会跳转到访问页面，此时你可以使用 <code class="docutils literal notranslate"><span class="pre">root</span></code> 用户访问，但是建议额外注册一个管理员用户来管理 Gitlab 服务。</p>
<img alt="../_images/注册新用户.png" src="../_images/注册新用户.png" />
</div>
<div class="section" id="id10">
<h3>变更主配置文件<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>每当我们要变更配置文件，需要执行以下步骤</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">gitlab-ctl</span> <span class="pre">reconfigure</span></code> 重置配置文件</li>
<li><code class="docutils literal notranslate"><span class="pre">gitlab-ctl</span> <span class="pre">show-config</span></code> 验证配置文件</li>
<li><code class="docutils literal notranslate"><span class="pre">gitlab-ctl</span> <span class="pre">restart</span></code>  重启配置文件</li>
</ol>
</div>
<div class="section" id="root">
<h3>修改 root 用户密码<a class="headerlink" href="#root" title="Permalink to this headline">¶</a></h3>
<p>对于普通用户而言，通过系统的重置密码，接收重置密码邮件即可，可是 Gitlab 的管理员账号，缺省的邮箱是一个不存在的邮箱地址，所在没有办法通过邮箱来重置密码。</p>
<p>使用命令 <code class="docutils literal notranslate"><span class="pre">gitlab-rails</span> <span class="pre">console</span> <span class="pre">production</span></code> 修改</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>gitlab-rails console production
-------------------------------------------------------------------------------------
GitLab:       11.3.0 (17bd59a)
GitLab Shell: 8.3.3
postgresql:   9.6.8
-------------------------------------------------------------------------------------
Loading production environment (Rails 4.2.10)
irb(main):001:0&gt;
irb(main):002:0* user = User.where(id: 1).first
=&gt; #&lt;User id:1 @root&gt;
irb(main):003:0&gt; user.password=12345678
=&gt; 12345678
irb(main):004:0&gt; user.password_confirmation=12345678
=&gt; 12345678
irb(main):005:0&gt; user.save!
Enqueued ActionMailer::DeliveryJob (Job ID: de0469c0-dea5-488d-9e04-8d4c550739c5) to Sidekiq(mailers) with arguments: &quot;DeviseMailer&quot;, &quot;password_change&quot;, &quot;deliver_now&quot;, gid://gitlab/User/1
=&gt; true
irb(main):006:0&gt; quit
</pre></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h2>权限管理<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<p>使用 <code class="docutils literal notranslate"><span class="pre">root</span></code> 用户进入 Gitlab 服务首页，如下所示</p>
<img alt="../_images/gitlab首页.png" src="../_images/gitlab首页.png" />
<p>点击导航栏中的 <code class="docutils literal notranslate"><span class="pre">admin</span> <span class="pre">area</span></code> 小扳手进入管理界面</p>
<img alt="../_images/管理界面.png" src="../_images/管理界面.png" />
<div class="section" id="id12">
<h3>创建用户<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">点击 <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">User</span></code> 按钮，创建新的用户。</p>
<blockquote>
<div><img alt="../_images/新建组按钮.png" src="../_images/新建组按钮.png" />
</div></blockquote>
</li>
<li><p class="first">进入新建用户配置页面</p>
<blockquote>
<div><img alt="../_images/新建用户配置页面.png" src="../_images/新建用户配置页面.png" />
</div></blockquote>
</li>
<li><p class="first">配置选项</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="18%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">内容</th>
<th class="head">选项</th>
<th class="head">含义与作用</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td rowspan="3">Account</td>
<td>Name</td>
<td>账户名称</td>
</tr>
<tr class="row-odd"><td>Username</td>
<td>用户名</td>
</tr>
<tr class="row-even"><td>Email</td>
<td>邮箱地址</td>
</tr>
<tr class="row-odd"><td rowspan="2">Password</td>
<td>Password</td>
<td>密码</td>
</tr>
<tr class="row-even"><td>Password confirmation</td>
<td>确认密码</td>
</tr>
<tr class="row-odd"><td rowspan="5">Access</td>
<td>Projects limit</td>
<td>项目限制</td>
</tr>
<tr class="row-even"><td>Can create group</td>
<td>是否能创建组</td>
</tr>
<tr class="row-odd"><td>Access level</td>
<td>Regular (普通用户)</td>
</tr>
<tr class="row-even"><td>Access level</td>
<td>Admin（管理员）</td>
</tr>
<tr class="row-odd"><td>External</td>
<td>除非明确授予访问权限，否则外部用户无法查看内部或私有项目。此外，外部用户无法创建项目或组。</td>
</tr>
<tr class="row-even"><td rowspan="5">Profile</td>
<td>Acatar</td>
<td>头像</td>
</tr>
<tr class="row-odd"><td>Skype</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Linkedin</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>Twitter</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>Website</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id13">
<h3>创建组<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>为什么需要有组？比如公司现在有开发团队，有不同项目，可以按照不同项目来分配组，组内包含了不同的成员。</p>
<ol class="arabic">
<li><p class="first">点击 <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">Group</span></code> 按钮，创建新的用户组。</p>
<blockquote>
<div><img alt="../_images/新建组按钮.png" src="../_images/新建组按钮.png" />
</div></blockquote>
</li>
<li><p class="first">进入新建组配置页面</p>
<blockquote>
<div><img alt="../_images/组配置信息.png" src="../_images/组配置信息.png" />
</div></blockquote>
</li>
<li><p class="first">配置选项</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">选项</th>
<th class="head">含义与作用</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Group path</td>
<td>组项目 URL 路径</td>
</tr>
<tr class="row-odd"><td>Group name</td>
<td>组项目名称</td>
</tr>
<tr class="row-even"><td>Description</td>
<td>组项目描述</td>
</tr>
<tr class="row-odd"><td>Group avatar</td>
<td>组项目图标</td>
</tr>
<tr class="row-even"><td rowspan="4">Visibility Level</td>
<td>Private（该组及其项目只能由成员查看）</td>
</tr>
<tr class="row-odd"><td>Internal（任何登录用户都可以查看该组和任何内部项目）</td>
</tr>
<tr class="row-even"><td>Public（无需任何身份验证即可查看该组和任何公共项目）</td>
</tr>
<tr class="row-odd"><td>Allow users to request access（如果公开或内部可见性，则允许用户请求访问权限）</td>
</tr>
<tr class="row-even"><td>Large File Storage</td>
<td>允许该组中的项目使用Git LFS</td>
</tr>
<tr class="row-odd"><td>Two-factor authentication</td>
<td>要求此组中的所有用户都设置双因素身份验证</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first">组创建成功</p>
<blockquote>
<div><img alt="../_images/组详细页面.png" src="../_images/组详细页面.png" />
</div></blockquote>
</li>
<li><p class="first">组授权</p>
<blockquote>
<div><p>组创建完成后，组内是没有用户的，创建组的用户就要赋权给其他的用户</p>
<ul>
<li><p class="first">选择用户加入组</p>
<blockquote>
<div><img alt="../_images/选择用户加入组.png" src="../_images/选择用户加入组.png" />
</div></blockquote>
</li>
<li><p class="first">设置用户在组中的角色</p>
<blockquote>
<div><img alt="../_images/设置用户角色.png" src="../_images/设置用户角色.png" />
</div></blockquote>
</li>
<li><p class="first">查看组成员</p>
<blockquote>
<div><img alt="../_images/查看组成员.png" src="../_images/查看组成员.png" />
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id14">
<h3>创建项目<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">点击 <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">project</span></code> 按钮，创建新的项目。</p>
<blockquote>
<div><img alt="../_images/新建项目按钮.png" src="../_images/新建项目按钮.png" />
</div></blockquote>
</li>
<li><p class="first">进入新建项目配置页面</p>
<blockquote>
<div><img alt="../_images/新建项目.png" src="../_images/新建项目.png" />
</div></blockquote>
</li>
<li><p class="first">选项配置</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="58%" />
<col width="42%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">选项</th>
<th class="head">含义与作用</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Project name</td>
<td>项目名称</td>
</tr>
<tr class="row-odd"><td>Project URL</td>
<td>项目URL</td>
</tr>
<tr class="row-even"><td>Project slug</td>
<td>项目块</td>
</tr>
<tr class="row-odd"><td>Project description</td>
<td>项目描述</td>
</tr>
<tr class="row-even"><td rowspan="3">Visibility Level</td>
<td>Private（私有）</td>
</tr>
<tr class="row-odd"><td>Internal（内部）</td>
</tr>
<tr class="row-even"><td>Public（公有）</td>
</tr>
<tr class="row-odd"><td>Initialize repository with a README、</td>
<td>初始化存储库的 README 文件</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id15">
<h3>项目密钥<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">给用户添加密钥</p>
<blockquote>
<div><p>当我们创建完成了组、用户与项目之后，用户需要上传公钥，否则 SSH 协议不能使用。</p>
<ul>
<li><p class="first">点击页面右上方的用户头像</p>
<blockquote>
<div><img alt="../_images/用户设置.png" src="../_images/用户设置.png" />
</div></blockquote>
</li>
<li><p class="first">进入用户配置页面，查看左侧用户配置选项</p>
<blockquote>
<div><img alt="../_images/用户配置选项.png" src="../_images/用户配置选项.png" />
</div></blockquote>
</li>
<li><p class="first">点击 <code class="docutils literal notranslate"><span class="pre">SSH</span> <span class="pre">keys</span></code> ，为用户添加 SSH 公钥</p>
<blockquote>
<div><img alt="../_images/SSH公钥配置.png" src="../_images/SSH公钥配置.png" />
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">本地生成密钥对</p>
<blockquote>
<div><ul>
<li><p class="first">用户本地主机生成密钥对</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ssh-keygen -b 4096 -t rsa -f ~/.ssh/gitlab -N &#39;&#39;
Generating public/private rsa key pair.
Your identification has been saved in /Users/renkeju/.ssh/gitlab.
Your public key has been saved in /Users/renkeju/.ssh/gitlab.pub.
The key fingerprint is:
SHA256:s427VY2KNaGXemMwu3ird02IK4/lo7OHCA7vLHfcAmI renkeju@laptop.local
The key&#39;s randomart image is:
+---[RSA 4096]----+
|                 |
|                 |
|          .      |
|         . o o   |
|        S.=.o .  |
|oEo     .&amp;.+.    |
|.= + o .B.Bo     |
|..+ = ==**...    |
| +o. .*@B=       |
+----[SHA256]-----+
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">查看密钥对</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ll .ssh/gitlab*
-rw-------  1 renkeju  staff   3.2K  9 27 15:46 .ssh/gitlab
-rw-r--r--  1 renkeju  staff   746B  9 27 15:46 .ssh/gitlab.pub
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">复制公钥</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cat .ssh/gitlab.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDIAmL6Hgb1hyi8ErvF2kd0o4lYVwn8EecdyMBrSViOjj0FxFz5NBXVZgZziuKiYN9EBQt+cf+ehbUquLJY/w5S3Rg08x8QMKnJCtQ0vK8vmuO6ljUxHlBzyQiSs4dQWIwhAUL5hJ+BrAHp+PbPvuX7nwZILPCGLZTlMIBTWIQtUwdZQDQmWZ0xxsXlHoa0w4NNgUcJOgrFF2A0E4jrzAOdUKWQfhCSBXEd6BZJ+QGOcRmIL3fPasJL3+B8X5GNs56DpXeByXLGSwgU605bog9oU6N3WqHvoLa1LwwUmpfospEB1DimS/7a31nMPera026Hvr851QUUAxZGjpYxZodJ1QcscH4ZOgafFZnH+8UiU6LWreb4cj/o56i+TuKntOAlQNb6R0M9C4E3B5BQI8l6Ob5nkr7ltujDTJGtTFPlF0oBxEqgkpnvjkLicZ6biCDa3f2bEU7k5Ez/kyrA1w639gnfF58KzyZuuhM9HG1ANK4KO9LGr/5MMqjbkr8ksiqcNG17YSmdQVWqmLU5Ai2tEnA5KLjHwiv2MXrzpBe1elIUXW7AHps+Tx+e/Q56K3vfJ43adxh+E+cFDqPyjpsBWdc6m7Js7hXuQ2Z5iFSVfyh9YxwmJudHLTkhTZhJi18qjnPyNy9Q/WwKVRq0NWXfqcd3aWjvmNXLe7HAXfhi7Q== renkeju@laptop.local
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">配置公钥</p>
<blockquote>
<div><ul>
<li><p class="first">将公钥黏贴到文本框内</p>
<blockquote>
<div><img alt="../_images/将公钥黏贴到文本框内.png" src="../_images/将公钥黏贴到文本框内.png" />
</div></blockquote>
</li>
<li><p class="first">已添加的公钥列表</p>
<blockquote>
<div><img alt="../_images/已添加公钥列表.png" src="../_images/已添加公钥列表.png" />
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id16">
<h3>部署密钥<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<div class="section" id="repository">
<h4>每个 Repository 部署密钥<a class="headerlink" href="#repository" title="Permalink to this headline">¶</a></h4>
<p>deploy keys 允许使用单个 SSH 密钥对 对一个或多个项目进行只读或读写（如果已启用）访问。</p>
<p>这对于将Repository克隆岛 Continuous Integration (CI) 服务器非常有用。通过使用部署密钥，您不必设置虚拟用户账户。如果您是项目维护者或所有者，则可以在”Repository“部分下的项目设置中添加部署密钥。为新部署密钥指定标题并黏贴 SSH 公钥。在这之后，使用相应的 SSH 私钥的计算机具有对项目有只读和读写（如果启用）访问权限。</p>
<img alt="../_images/项目部署密钥.png" src="../_images/项目部署密钥.png" />
<p>您无法使用表单两次添加相同的部署密钥。如果要将相同的密钥添加到另一个项目，请在”从可用项目部署密钥“列表中启用它。您可以访问的所有项目的所有部署密钥都可用。该项目访问可以通过称为项目的直接成员或通过组来实现。</p>
<p>部署密钥可以在项目之间共享，您只需要将它们添加到每个项目中。</p>
</div>
<div class="section" id="id17">
<h4>全局共享部署密钥<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>Global Shared Deploy keys 允许在整个 Gitlab 安装中的任何Repository上配置只读或读写（如果启用）访问。</p>
<p>这对于将Repository集成到安全的共享持续集成（CI）服务或其他共享服务非常有用。Gitlab 管理员可以在 Gitlab 中设置 Global Shared Deploy keys，并将私钥添加到任何共享系统。当项目维护者（或更高级别）授权将 Global Shared Deploy keys 用于其项目时，各个Repository会选择使用这些密钥公开其Repository。</p>
<p>与每个项目部署密钥相比，全局共享密钥可以提供更高的安全性，因为目标集成系统的管理员是唯一需要知道和配置私钥的人。</p>
<p>Gitlab 管理员在”部署密钥“部分下的”管理“区域中设置 Global Depoly keys 。确保密钥具有有意义的标题，因为这将是项目维护者和所有者识别要添加的正确 Global Deploy keys 的主要方式。例如，如果密钥提供对 SaaS CI 实例的访问权限，则在密钥名称中使用该服务的名称（如果它是用于全局）。在创建全局共享部署密钥时，请考虑密钥的粒度 —— 它们的使用范围非常狭窄，例如知识特定服务或更广泛的用途，例如“您需要提供对Repository的读取访问权限”。</p>
<p>一旦 Gitlab 管理员添加全局部署密钥，项目维护人员和所有者就可以通过展开 “部署密钥” 部分并单击任何项目可用的公共部署密钥下列出的相应密钥旁边的“启用”，将其添加到项目的 “Settings” -&gt; “Repository” 部分中。</p>
<ol class="arabic">
<li><p class="first">导航栏选择小扳手</p>
<blockquote>
<div><p>使用具有管理员权限的用户登录才可以看到小扳手</p>
<img alt="../_images/导航栏.png" src="../_images/导航栏.png" />
</div></blockquote>
</li>
<li><p class="first">左侧导航栏选择 <code class="docutils literal notranslate"><span class="pre">Deploy</span> <span class="pre">keys</span></code> 选项</p>
<blockquote>
<div><img alt="../_images/左侧选择栏.png" src="../_images/左侧选择栏.png" />
</div></blockquote>
</li>
<li><p class="first">点击 <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">deploy</span> <span class="pre">key</span></code> 按钮</p>
<blockquote>
<div><img alt="../_images/新建公共部署密钥.png" src="../_images/新建公共部署密钥.png" />
</div></blockquote>
</li>
<li><p class="first">黏贴公钥到框内，点击 <code class="docutils literal notranslate"><span class="pre">Create</span></code> 按钮创建</p>
<blockquote>
<div><img alt="../_images/公共部署密钥.png" src="../_images/公共部署密钥.png" />
</div></blockquote>
</li>
<li><p class="first">切换到其他用户，添加公共权限部署密钥</p>
<blockquote>
<div><img alt="../_images/添加公共权限部署密钥.png" src="../_images/添加公共权限部署密钥.png" />
</div></blockquote>
</li>
<li><p class="first">启用公共部署密钥</p>
<blockquote>
<div><img alt="../_images/启用公共部署密钥.png" src="../_images/启用公共部署密钥.png" />
</div></blockquote>
</li>
<li><p class="first">查看已启用部署密钥</p>
<blockquote>
<div><img alt="../_images/已启用部署密钥.png" src="../_images/已启用部署密钥.png" />
</div></blockquote>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">只有配置了至少一个 Global Deploy keys 时，才会显示 可用于任何项目 的标题公共部署密钥。</p>
</div>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">定义全局部署密钥不会通过密钥公开任何给定的 Repository ，知道该 Repository 将 Global Deploy keys 添加到其项目中。通过这种方式，全局部署密钥可以启用其他系统的访问，但不要仅通过它们来隐式地提供任何访问。</p>
</div>
</div>
</div>
</div>
<div class="section" id="issues">
<h2>issues<a class="headerlink" href="#issues" title="Permalink to this headline">¶</a></h2>
<p>Gitlabn 除了提供基于 git 的基本代码托管服务外。还具备很多与软件开发协作相关的其他功能。比如 issues、Merge Requests 等。</p>
<p>利用 Gitlab 提供的这些功能，我们可以时间一些简单的项目管理和协作流程。这套流程借鉴很多成功的开源项目，非常适合在小型开发团队里面使用。</p>
<div class="section" id="id18">
<h3>使用 issues 来管理需求与缺陷<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<p>Gitlab issues 类似于”工单系统“，是一个发布相关信息的地方。项目的所有成员都可以创建新的 issue，其他成员可以在 issue 下进行相关的讨论。</p>
<p>issue 本身是一个非常简单的功能，但是如果配合”标签“、”里程碑“等功能一起使用，就可以承担起一定的项目管理工作。</p>
<div class="section" id="issue">
<h4>录入 issue<a class="headerlink" href="#issue" title="Permalink to this headline">¶</a></h4>
<p>在项目的开发过程中，我们会碰到很多新的需求，软件 bug 等。这些需求与 bug，就是 issue 最大的来源，它们都可以作为 issue 录入到项目的 issues 中。</p>
<p>因为 issue 的录入门槛很低，鼓励项目成员录入 issue 后，项目很容易就会出现大量的 issues。所以我们应该严格控制每个 issue 的内容质量，确保其他人可以通过这个 issue 获取足够多的信息，提高沟通效率。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">不光是需求和 bug，任何和项目有关的内容都可以录入到 issue 中。</p>
</div>
<div class="section" id="id19">
<h5>编写优秀的 ”需求“ issue<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h5>
<p>如果你要录入一个需求类的 issue，最好在内容的主体中包含下面的这些内容：</p>
<ol class="arabic simple">
<li>用一句话描述你的需求，并用它作为标题</li>
<li>这个需求是解决什么问题的？</li>
<li>这个需求对软件现有的功能会造成什么影响？</li>
<li>这个需求应该实现什么样的功能？</li>
<li>这个需求是否依赖其他模块提供相关的支持？</li>
<li>这个需求有哪些实现方式？【可选】</li>
<li>这些可选的实现方式分别有哪些优缺点？【可选】</li>
</ol>
</div>
<div class="section" id="bug-issue">
<h5>编写优秀的 “bug” issue<a class="headerlink" href="#bug-issue" title="Permalink to this headline">¶</a></h5>
<p>如果你要录入一个 bug issue，最好在内容主题中包含下面这些内容：</p>
<ol class="arabic simple">
<li>提供出现问题的软件版本号、操作系统环境等相关信息</li>
<li>提供能够稳定复现问题的相关步骤</li>
<li>描述期待行为与当前行文</li>
<li>你对这个 bug 原因的相关分析【可选】</li>
</ol>
</div>
</div>
<div class="section" id="review-issue">
<h4>Review issue 并为其打上标签<a class="headerlink" href="#review-issue" title="Permalink to this headline">¶</a></h4>
<p>当 issue 被创建后，应该等待项目的 owner（owner 指项目的所有者，是对项目各方面都比较了解的人，可以为多个人）对 issue 进行 Review。</p>
<p>Review 时，如果 owner 觉得这个 issue 满足下面的任意条件：</p>
<ol class="arabic simple">
<li>与项目本身的功能、市场定位有冲突</li>
<li>与现存 issue 有重复</li>
<li>其他不应该被保留的情况</li>
</ol>
<p>则应该在评论中说明相关情况，并关闭该 issue。如果讲过上面的过滤后，觉得 issue 应该被继续跟进，那就应该为它打上标签，方便之后的筛选、排期等工作。</p>
<p>“标签”是 issue 的核心特性，为了更好的使用它，我建议采用 <code class="docutils literal notranslate"><span class="pre">{type}/{value}</span></code> 这样的二维标签来取代传统的 <code class="docutils literal notranslate"><span class="pre">{value}</span></code> 单维标签，下面是一些常用的 issue 标签：</p>
<div class="section" id="priority">
<h5>优先级：priority<a class="headerlink" href="#priority" title="Permalink to this headline">¶</a></h5>
<p>优先级（priority）是最重要的标签之一。它直接影响 bug 需要被响应的速度、或需求的具体排期。</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">priority/P0</span></code> 十分紧急</li>
<li><code class="docutils literal notranslate"><span class="pre">priority/P1</span></code> 较为紧急</li>
<li><code class="docutils literal notranslate"><span class="pre">priority/P2</span></code> 普通</li>
<li><code class="docutils literal notranslate"><span class="pre">priority/P3</span></code> 不紧急</li>
</ul>
</div>
<div class="section" id="kind">
<h5>类型：kind<a class="headerlink" href="#kind" title="Permalink to this headline">¶</a></h5>
<p>kind（类别）表示 issue 属于哪种类型</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">kind/bug</span></code> 软件缺陷</li>
<li><code class="docutils literal notranslate"><span class="pre">kind/featrue</span></code> 新功能</li>
<li><code class="docutils literal notranslate"><span class="pre">kind/enhancement</span></code> 改进项，模块代码重构等不影响项目功能但是改善工程质量的 issue 可归入此类</li>
<li><code class="docutils literal notranslate"><span class="pre">kind/research</span></code> 技术调研类，一般以输出某类结论或报告视为结束</li>
</ul>
</div>
<div class="section" id="size">
<h5>工作量：size<a class="headerlink" href="#size" title="Permalink to this headline">¶</a></h5>
<p>size（工作量）表示 issue 需要大约花费多少时间/精力，可以用来简单的工作量评估参考。</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">size/XL</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">size/M</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">size/SM</span></code></li>
</ul>
</div>
<div class="section" id="area">
<h5>领域/模块：area<a class="headerlink" href="#area" title="Permalink to this headline">¶</a></h5>
<p>area 用于标记当前 issue 属于项目中什么领域/模块。这个分类下的具体标签有项目本身决定。比如 <code class="docutils literal notranslate"><span class="pre">area/apiserver</span></code> 、 <code class="docutils literal notranslate"><span class="pre">area/controller</span></code> 等。给 issue 打上 area 标签后，项目不同模块的相关负责人可以更方便的找到自己负责相关的 issues。</p>
<p>Gitlab 的标签是一个非常灵活的功能，在具体的使用中，不必拘泥于上面列出来的几种标签，可以根据当前项目特点随意调整。</p>
</div>
</div>
<div class="section" id="id20">
<h4>Issue 的后续操作<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>当 issue 被创建、打上标签以后，就可以进行后续操作了。issue 的后续操作主要包括下面几种：</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">认领</span> <span class="pre">issue</span></code> 每一个 issue 都有一个 Assignee（受理人），表示当前 issue 由谁在处理。在你准备开始具体工作前，一定要记得 issue 认领为自己所有。</li>
<li><code class="docutils literal notranslate"><span class="pre">在</span> <span class="pre">issue</span> <span class="pre">下进行讨论</span></code> 在 issue 下可以围绕 issue 进行讨论，在讨论过程中，可以通过 <code class="docutils literal notranslate"><span class="pre">&#64;USERNAME</span></code> 的方式通知其他人关注当前 issue。</li>
</ul>
</div>
<div class="section" id="id21">
<h4>使用 issue 做项目里程碑管理<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h4>
<p>除了为 issue 打上标签以外，你还可以为 issue 绑定上 milestone（里程碑），来将 issue 与某些特定的项目节点关联起来。之后便可以在 milestones 页面查看每一个里程碑的进展。</p>
<p>和 labels 一样，里程碑也是一个十分灵活的功能，你可以根据项目需要建立不同的里程碑，比如：</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">基于软件版本号</span></code>：基于未来将要发布的版本号建立里程碑，比如 <code class="docutils literal notranslate"><span class="pre">v1.0.3</span></code> 、 <code class="docutils literal notranslate"><span class="pre">v2.0.1</span></code> 等等</li>
<li><code class="docutils literal notranslate"><span class="pre">基于时间周期</span></code>：基于特定的时间周期 - 比如敏捷开发中的一个 sprint - 来建立里程碑，比如 <code class="docutils literal notranslate"><span class="pre">Y2017-M7W3</span></code> 、 <code class="docutils literal notranslate"><span class="pre">Y2017-M7W4</span></code> 等等</li>
</ul>
</div>
<div class="section" id="issue-board">
<h4>使用 issue board<a class="headerlink" href="#issue-board" title="Permalink to this headline">¶</a></h4>
<p>随着项目越来越大，项目累积的 issue 也会越来越多。而这些 issue 中有很多已经失去它的价值。</p>
<p>所以，为了避免有价值的 issue 淹没在这些过时的信息当中，我们应该定期 Review 现有的 issues，关闭掉那些已经过时的 issues。</p>
</div>
</div>
<div class="section" id="merge-request">
<h3>基于 Merge Request 的开发流程<a class="headerlink" href="#merge-request" title="Permalink to this headline">¶</a></h3>
<p>在 Gitlab 上创建的项目，所有人都不应该直接往 master 分支推送代码。而是应该在其他分支（或者 fork 项目的分支）进行开发。并最终通过创建 Merge Request（类似 Github pull request）将代码合并到 master 分支。</p>
<div class="section" id="merge-request-code-review">
<h4>创建 Merge Request 并进行 Code Review<a class="headerlink" href="#merge-request-code-review" title="Permalink to this headline">¶</a></h4>
<p>基于 MR 的开发流程如下：</p>
<ul class="simple">
<li>开发者在自己的分支下进行开发，开发完成后，创建将该分支合并到 Master 的 Merge Request，改动进入 Review 状态。</li>
<li>进入 Review 状态的代码，将由团队内的其他一位成员（经验比较丰富、或者对该工作模块比较熟悉）对代买改动进行 Code Review。</li>
<li>大家对 Review 结果进行讨论，并提交新的修改。</li>
<li>最终达成一致后，代码被 Merge 进 Master 分支。</li>
</ul>
</div>
<div class="section" id="mr">
<h4>灵活创建新分支来避免 MR 冲突<a class="headerlink" href="#mr" title="Permalink to this headline">¶</a></h4>
<p>我们一般会用类似与 <code class="docutils literal notranslate"><span class="pre">dev_piglei</span></code> 这样的分支名称进行开发，遵循着 “开发” -&gt; “push 并创建 MR” -&gt; “开发” 这样的工作流程。</p>
<p>但是，因为一个分支是严格对应到一个 MR 的，当你在同一个分支上开发不同功能时，如果 MR 一直处于 open 状态，那这些不同功能都会被推送到同一个 MR 上，对 Review 过程产生困扰。</p>
<p>为了避免这种情况，最好为不同的功能项创建不同的分支并各自创建 MR，比如
<code class="docutils literal notranslate"><span class="pre">dev_feature_add_member</span></code> 、 <code class="docutils literal notranslate"><span class="pre">dev_featrue_disabled_user</span></code> 。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">在 git 工作流方面，<a class="reference external" href="https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow">git-flow workflow</a> 是一个值得学习的内容。</p>
</div>
</div>
<div class="section" id="id22">
<h4>分拆大的 Merge Request<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h4>
<p>如果开发一些比较大的需求，我们通常会将他们一次实现完，然后作为一个大的 MR 来提交 Review。</p>
<p>但是如果每个 MR 过于复杂，会大大影响 Code Review 的效率。所以，如果你要实现一个比较复杂的特性，建议将它拆解为多个比较小的 MR 来依次提交。</p>
<p>假如，你要为网站的 feed 页面从零开始添加 redis 缓存功能。可能一开始想的提交这个大 MR：</p>
<ul>
<li><p class="first">[MR] 添加基于 redis 的缓存模块并为 feed 页面添加缓存并主动过期</p>
<blockquote>
<div><p>但这个 MR 里面包含了太多内容，会增加 Review 的难度。所以可以试着将这个功能拆解为下面三个更小的 MR：</p>
<ul class="simple">
<li>[MR] 添加基于缓存的模块</li>
<li>[MR] 为缓存模块添加 Redis 作为存储后端</li>
<li>[MR] 为 feed 页面提供缓存，并主动过期</li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<ul class="last simple">
<li>超过 1000 行的代码改动 Review 起来非常困难</li>
<li>可以使用 feature flag（功能开关）在 PR 完全完成前屏蔽部分功能</li>
</ul>
</div>
</div>
</div>
</div>
<div class="section" id="id23">
<h2>备份管理<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h2>
<p>对 gitlab 进行备份将会创建一个包含所有库和附件的文档文件。对备份的恢复只能恢复到与备份时的 gitlab 相同的版本。将 gitlab 迁移到另一台服务器上的最佳方法就是通过备份和还原。</p>
<p>gitlab 提供了一个简单的命令来备份整个 gitlab，并且能灵活的满足需求。</p>
<div class="section" id="id24">
<h3>配置文件<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1">### Backup Settings</span>
<span class="c1">###! Docs: https://docs.gitlab.com/omnibus/settings/backups.html</span>

<span class="c1"># gitlab_rails[&#39;manage_backup_path&#39;] = true</span>
<span class="c1"># gitlab_rails[&#39;backup_path&#39;] = &quot;/var/opt/gitlab/backups&quot;</span>

<span class="c1">###! Docs: https://docs.gitlab.com/ce/raketasks/backup_restore.html#backup-archive-permissions</span>
<span class="c1"># gitlab_rails[&#39;backup_archive_permissions&#39;] = 0644</span>

<span class="c1"># gitlab_rails[&#39;backup_pg_schema&#39;] = &#39;public&#39;</span>

<span class="c1">###! The duration in seconds to keep backups before they are allowed to be deleted</span>
<span class="c1"># gitlab_rails[&#39;backup_keep_time&#39;] = 604800</span>

<span class="c1"># gitlab_rails[&#39;backup_upload_connection&#39;] = {</span>
<span class="c1">#   &#39;provider&#39; =&gt; &#39;AWS&#39;,</span>
<span class="c1">#   &#39;region&#39; =&gt; &#39;eu-west-1&#39;,</span>
<span class="c1">#   &#39;aws_access_key_id&#39; =&gt; &#39;AKIAKIAKI&#39;,</span>
<span class="c1">#   &#39;aws_secret_access_key&#39; =&gt; &#39;secret123&#39;</span>
<span class="c1"># }</span>
<span class="c1"># gitlab_rails[&#39;backup_upload_remote_directory&#39;] = &#39;my.s3.bucket&#39;</span>
<span class="c1"># gitlab_rails[&#39;backup_multipart_chunk_size&#39;] = 104857600</span>

<span class="c1">###! **Turns on AWS Server-Side Encryption with Amazon S3-Managed Keys for</span>
<span class="c1">###!   backups**</span>
<span class="c1"># gitlab_rails[&#39;backup_encryption&#39;] = &#39;AES256&#39;</span>

<span class="c1">###! **Specifies Amazon S3 storage class to use for backups. Valid values</span>
<span class="c1">###!   include &#39;STANDARD&#39;, &#39;STANDARD_IA&#39;, and &#39;REDUCED_REDUNDANCY&#39;**</span>
<span class="c1"># gitlab_rails[&#39;backup_storage_class&#39;] = &#39;STANDARD&#39;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="59%" />
<col width="41%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>关键字</td>
<td>含义</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['manage_backup_path']</span></code></td>
<td>管理备份文件路径</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['backup_path']</span></code></td>
<td>定义备份文件路径</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['backup_archive_permissions']</span></code></td>
<td>指定备份文件权限</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['backup_pg_schema']</span></code></td>
<td>指定备份 postgresql 数据库表名称</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['backup_keep_time']</span></code></td>
<td>备份文件保存时间</td>
</tr>
</tbody>
</table>
<p>备份文件还支持上传到云端，支持 AWS、google、openstack swift 和 rackspace。</p>
<p>配置文件修改完成之后，请重新执行下面的命令使配置文件生效。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo gitlab-ctl reconfigure
</pre></div>
</div>
</div>
<div class="section" id="id25">
<h3>备份时间戳<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<p>从 gitlab 9.2 版本开始，时间戳格式由 <code class="docutils literal notranslate"><span class="pre">EPOCH_YYYY_MM_DD</span></code> 更改为 <code class="docutils literal notranslate"><span class="pre">EPOCH_YYYY_MM_DD_Gitlab-version</span></code>。</p>
<p>备份文件将保存在 gitlab.yml 文件中定义的 backup_path 中，文件名为 <code class="docutils literal notranslate"><span class="pre">TIMESTAMP_gitlab_backup.tar</span></code> ，TIMESTAMP 为备份时的时间戳。</p>
<ol class="arabic">
<li><p class="first">使用二进制软件包安装</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo gitlab-rake gitlab:backup:create
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">在 docker 中运行的 gitlab</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker <span class="nb">exec</span> -c &lt;container name&gt; gitlab-rake gitlab:backup:create
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id26">
<h3>备份策略选项<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<p>该选项对 gitlab 8.17 及以上版本有效。</p>
<p>默认的备份策略是使用 linux 的 tar/gzip 命令。这在大多数情况下是没有问题的，但是当数据在打包过程中发生变化时，将会有错误抛出 <code class="docutils literal notranslate"><span class="pre">file</span> <span class="pre">changed</span> <span class="pre">as</span> <span class="pre">we</span> <span class="pre">read</span> <span class="pre">it</span></code> ，这会导致备份进程失败。</p>
<p>为了解决这个问题，8.17 引入了一个名为 copy 的备份策略，就是在调用 tar、gzip 时将数据拷贝到一个临时位置。不过也引入了另外一个问题，将额外占用一倍的磁盘空间。</p>
<p>要使用复制策略而不是默认流策略，可以指定：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo gitlab-rake gitlab:backup:create <span class="nv">STRATEGY</span><span class="o">=</span>copy
</pre></div>
</div>
</div>
<div class="section" id="id27">
<h3>排除特定目录<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<p>通过加环境变量选择跳过要备份的内容。可用的选项有：</p>
<table border="1" class="docutils">
<colgroup>
<col width="34%" />
<col width="66%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>选项</td>
<td>内容</td>
</tr>
<tr class="row-even"><td>db</td>
<td>数据库</td>
</tr>
<tr class="row-odd"><td>uploads</td>
<td>附件</td>
</tr>
<tr class="row-even"><td>repositories</td>
<td>Git repositories 数据</td>
</tr>
<tr class="row-odd"><td>builds</td>
<td>CI job output logs</td>
</tr>
<tr class="row-even"><td>artifacts</td>
<td>CI job artifacts</td>
</tr>
<tr class="row-odd"><td>lfs</td>
<td>LFS objects</td>
</tr>
<tr class="row-even"><td>registry</td>
<td>Container Registry images</td>
</tr>
<tr class="row-odd"><td>pages</td>
<td>Pages content</td>
</tr>
</tbody>
</table>
<p>指定多个选项使用逗号分隔</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo gitlab-rake gitlab:backup:create <span class="nv">SKIP</span><span class="o">=</span>db,uploads
</pre></div>
</div>
</div>
<div class="section" id="crontab">
<h3>使用 crontab 定时备份<a class="headerlink" href="#crontab" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">0</span> <span class="m">2</span> * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create <span class="nv">CRON</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>环境变量 <code class="docutils literal notranslate"><span class="pre">CRON=1</span></code> 的作用是如果没有任何错误发生时，避免备份脚本的所有进度输出。将以将 /etc/gitlab 备份到安全的地方。如果要还原 gitlab 应用程序，还需要还原 gitlab-secrets.json 。如果没有，那么使用双重身份验证的 Gitlab 用户将无法访问 Gitlab 服务器，而存储在 Gitlab 中的“安全变量”将被丢失。</p>
<p>所有配置都存储在 <code class="docutils literal notranslate"><span class="pre">/etc/gitlab</span></code> 中，只需要备份此目录</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo sh -c <span class="s1">&#39;umask 0077; tar -cf $(date &quot;+etc-gitlab-%s.tar&quot;)  /etc/gitlab&#39;</span>
</pre></div>
</div>
<p>使用 crontab</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="m">0</span> <span class="m">2</span> * * *  <span class="nb">umask</span> <span class="m">0077</span><span class="p">;</span> tar cfz /secret/gitlab/backups/<span class="k">$(</span>date <span class="s2">&quot;+etc-gitlab-\%s.tgz&quot;</span><span class="k">)</span>  /etc/gitlab
</pre></div>
</div>
<p>服务器的 SSH 主机密钥存储在 <code class="docutils literal notranslate"><span class="pre">/etc/ssh/</span></code> 目录中，如果必须执行完整的服务器还原，请确保备份和还原这些密钥，以避免中间人攻击的警告。</p>
</div>
<div class="section" id="id28">
<h3>恢复备份<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<p>只能还原到与备份文件相同的 gitlab 版本。</p>
<p>首先有安装与备份文件相同的 gitlab，执行 <code class="docutils literal notranslate"><span class="pre">gitlab-ctl</span> <span class="pre">reconfigure</span></code>。如果 gitlab 没有运行，需要执行 <code class="docutils literal notranslate"><span class="pre">gitlab-ctl</span> <span class="pre">start</span></code>。并确保备份文件位于 <code class="docutils literal notranslate"><span class="pre">gitlab_rails['backup_path']</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop sidekiq
sudo gitlab-ctl status
sudo gitlab-rake gitlab:backup:restore <span class="nv">BACKUP</span><span class="o">=</span>1493107454_2017_04_25_9.1.0
sudo gitlab-ctl start
sudo gitlab-rake gitlab:check <span class="nv">SANITIZE</span><span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id29">
<h2>邮件配置<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h2>
<p>邮件是 Gitlab 不可或缺的一个部分，它提供了代码提交提醒，用户密码找回等功能。Gitlab 也提供了几种邮件配置方案，有 sendmail，postfix 和 smtp 。这里只介绍 smtp，其中 sendmail 太过于古老，现在几乎被 postfix 替代了，而 postfix 配置没有 smtp 方便。</p>
<div class="section" id="id30">
<h3>修改配置文件<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># gitlab_rails[&#39;time_zone&#39;] = &#39;UTC&#39;</span>

<span class="c1">### Email Settings</span>
<span class="c1"># gitlab_rails[&#39;gitlab_email_enabled&#39;] = true</span>
<span class="c1"># gitlab_rails[&#39;gitlab_email_from&#39;] = &#39;example@example.com&#39;</span>
<span class="c1"># gitlab_rails[&#39;gitlab_email_display_name&#39;] = &#39;Example&#39;</span>
<span class="c1"># gitlab_rails[&#39;gitlab_email_reply_to&#39;] = &#39;noreply@example.com&#39;</span>
<span class="c1"># gitlab_rails[&#39;gitlab_email_subject_suffix&#39;] = &#39;&#39;</span>

<span class="c1">### GitLab email server settings</span>
<span class="c1">###! Docs: https://docs.gitlab.com/omnibus/settings/smtp.html</span>
<span class="c1">###! **Use smtp instead of sendmail/postfix.**</span>

<span class="c1"># gitlab_rails[&#39;smtp_enable&#39;] = true</span>
<span class="c1"># gitlab_rails[&#39;smtp_address&#39;] = &quot;smtp.server&quot;</span>
<span class="c1"># gitlab_rails[&#39;smtp_port&#39;] = 465</span>
<span class="c1"># gitlab_rails[&#39;smtp_user_name&#39;] = &quot;smtp user&quot;</span>
<span class="c1"># gitlab_rails[&#39;smtp_password&#39;] = &quot;smtp password&quot;</span>
<span class="c1"># gitlab_rails[&#39;smtp_domain&#39;] = &quot;example.com&quot;</span>
<span class="c1"># gitlab_rails[&#39;smtp_authentication&#39;] = &quot;login&quot;</span>
<span class="c1"># gitlab_rails[&#39;smtp_enable_starttls_auto&#39;] = true</span>
<span class="c1"># gitlab_rails[&#39;smtp_tls&#39;] = false</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="72%" />
<col width="28%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>关键字</td>
<td>含义</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['time_zone']</span></code></td>
<td>时区设置</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['gitlab_email_enabled']</span></code></td>
<td>开启邮件服务</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['gitlab_email_from']</span></code></td>
<td>发送邮件来源地址</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['gitlab_email_display_name']</span></code></td>
<td>邮件显示用户名</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['gitlab_email_reply_to']</span></code></td>
<td>邮件回复地址</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['gitlab_email_subject_suffix']</span></code></td>
<td>邮件主体后缀</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['smtp_enable']</span></code></td>
<td>开启 smtp 服务</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['smtp_address']</span></code></td>
<td>smtp 服务器地址</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['smtp_port']</span></code></td>
<td>smtp 服务端口</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['smtp_user_name']</span></code></td>
<td>smtp 账户用户名称</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['smtp_password']</span></code></td>
<td>smtp 账户密码</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['smtp_domain']</span></code></td>
<td>smtp 服务域</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['smtp_authentication']</span></code></td>
<td>smtp 认证方式</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['smtp_enable_starttls_auto']</span></code></td>
<td>开启自动tls认证</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">gitlab_rails['smtp_tls']</span></code></td>
<td>tls 认证</td>
</tr>
</tbody>
</table>
<p>修改完成后，重新加载配置文件并重启</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo gitlab-ctl reconfigure
sudo gitlab-ctl restart
</pre></div>
</div>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">126邮箱和163邮箱都没有TLS加密设置，所以默认只能使用 25 端口。</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../jenkins/jenkins.html" class="btn btn-neutral float-right" title="jenkins" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../git/git.html" class="btn btn-neutral" title="git" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, renkeju.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'alpha',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>